<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¾›åº”å•†æŠ¥ä»·æ•´åˆ</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <!-- ===== é¡¶éƒ¨å¯¼èˆª ===== -->
  <header class="navbar">
    <div class="logo"><a href="index.html">åŒ»è¯é‡‡è´­å¹³å°</a></div>
    <nav class="nav-links">
      <a href="upload.html">Excelå¯¼å…¥</a>
      <a href="result.html">æ‰¹é‡ç»“æœ</a>
      <a href="detail.html" class="opt-single">å•å“ç»“æœ</a>
    </nav>
  </header>

  <main>
    <!-- æŠ¥ä»·è¿›åº¦å¡ç‰‡ -->
    <div class="card" id="quoteProgress">
      <p>æŠ¥ä»·è¿›åº¦ï¼š<strong id="quoteNum">2</strong>/<strong id="supplierTotal">5</strong> å®¶ä¾›åº”å•†å·²æŠ¥ä»·</p>
      <div class="progress-bar"><div class="progress-fill" id="quoteBar" style="width:40%"></div></div>
      <p style="font-size:14px;color:#666;">å‰©ä½™ 3 å®¶ä¾›åº”å•†å¾…æŠ¥ä»·â€¦</p>
    </div>

    <!-- è¿‡æ»¤å™¨æ¡ -->
    <div class="card" id="filterBar">
      <label>æ•ˆæœŸ â‰¥ <input type="month" id="fExp"></label>
      <label style="margin-left:12px;">äº¤æœŸ â‰¤ <input type="number" id="fLead" style="width:60px;"> å¤©</label>
      <label style="margin-left:12px;">æ˜Ÿçº§ â‰¥
        <select id="fRate">
          <option value="">å…¨éƒ¨</option><option>3</option><option>4</option><option>5</option>
        </select>
      </label>
      <button class="btn" id="filterBtn" style="margin-left:12px;">ç­›é€‰</button>
    </div>

    <!-- æŠ¥ä»·æ•´åˆè¡¨ -->
    <h2>ä¾›åº”å•†æŠ¥ä»·æ•´åˆ</h2>
    <div class="card">
      <table id="quoteTable" border="1" cellpadding="6" width="100%">
        <thead>
          <tr>
            <th>å•†å“</th><th>ä¾›åº”å•†</th><th>æŠ¥ä»·</th><th>äº¤æœŸ</th>
            <th>å»ºè®®é‡‡è´­</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          <tr data-exp="2026-12" data-lead="2" data-rate="5">
            <td>é˜¿è«è¥¿æ—</td>
            <td>Aè¯å‚</td>
            <td>Â¥15.2</td>
            <td>2å¤©</td>
            <td><input type="checkbox" class="chk-suggest" data-price="15.2"></td>
            <td>
              <button class="btn-secondary btn-chat"  data-sup="Aè¯å‚">ğŸ’¬</button>
              <button class="btn-secondary btn-inform" data-sup="Aè¯å‚">ğŸ“¨</button>
            </td>
          </tr>
          <tr data-exp="2027-01" data-lead="3" data-rate="4">
            <td>é˜¿è«è¥¿æ—</td>
            <td>Bè¯å‚</td>
            <td>Â¥15.8</td>
            <td>3å¤©</td>
            <td><input type="checkbox" class="chk-suggest" data-price="15.8"></td>
            <td>
              <button class="btn-secondary btn-chat"  data-sup="Bè¯å‚">ğŸ’¬</button>
              <button class="btn-secondary btn-inform" data-sup="Bè¯å‚">ğŸ“¨</button>
            </td>
          </tr>
        </tbody>
      </table>
      <br>
      <button class="btn" id="autoAssignBtn">è‡ªåŠ¨åˆ†é…é‡‡è´­é‡</button>
      <button class="btn" id="exportBtn">å¯¼å‡ºæ¯”ä»·ç»“æœ</button>
    </div>

    <div class="return-home"><a href="index.html" class="btn-secondary">è¿”å›é¦–é¡µ</a></div>
  </main>

  <!-- ===== é€šç”¨èŠå¤©å¼¹çª— ===== -->
  <div id="chatPopup" class="popup" style="display:none;">
    <div class="card" style="width:320px;max-height:70vh;display:flex;flex-direction:column;">
      <h3 id="chatTitle" style="margin-top:0;">ä¸ä¾›åº”å•†æ²Ÿé€š</h3>
      <div id="chatBody" style="flex:1;overflow-y:auto;border:1px solid #eee;padding:6px;margin-bottom:8px;"></div>
      <textarea id="chatInput" rows="2" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" style="resize:none;"></textarea>
      <button class="btn" onclick="sendMsg()">å‘é€</button>
      <button class="btn-secondary" onclick="chatClose()">å…³é—­</button>
    </div>
  </div>

  <script src="js/common.js"></script>

  <!-- ===== é¡µé¢ä¸“ç”¨è„šæœ¬ ===== -->
  <script>
  /* 1. è¿›åº¦æ¡ç¤ºä¾‹ */
  const done=2,total=5;
  document.getElementById('quoteNum').textContent=done;
  document.getElementById('supplierTotal').textContent=total;
  document.getElementById('quoteBar').style.width=(done/total*100)+'%';

  /* 2. è¿‡æ»¤å™¨ */
  document.getElementById('filterBtn').onclick=()=>{
    const exp  = document.getElementById('fExp').value;
    const lead = document.getElementById('fLead').value;
    const rate = document.getElementById('fRate').value;
    document.querySelectorAll('#quoteTable tbody tr').forEach(tr=>{
      const ok = (!exp  || tr.dataset.exp  >= exp) &&
                 (!lead || Number(tr.dataset.lead) <= lead) &&
                 (!rate || Number(tr.dataset.rate) >= rate);
      tr.style.display = ok ? '' : 'none';
    });
  };

  /* 3. è‡ªåŠ¨åˆ†é…é‡‡è´­é‡ï¼ˆç¤ºä¾‹ï¼šä»…å‹¾é€‰æœ€ä½ä»·ï¼‰ */
  document.getElementById('autoAssignBtn').onclick=()=>{
    let min=Infinity, minRow=null;
    document.querySelectorAll('.chk-suggest').forEach(chk=>{
      const price = Number(chk.dataset.price);
      if(price<min){min=price; minRow=chk;}
    });
    document.querySelectorAll('.chk-suggest').forEach(chk=>chk.checked=false);
    if(minRow) minRow.checked=true;
    alert('å·²æŒ‰æœ€ä½æŠ¥ä»·è‡ªåŠ¨å‹¾é€‰å»ºè®®é‡‡è´­ï¼');
    /* TODO: æ›´å¤æ‚çš„åˆ†é…é€»è¾‘ã€ä¸åç«¯äº¤äº’ååˆ·æ–°é¡µé¢ */
  };

  /* 4. å¯¼å‡º CSV */
  document.getElementById('exportBtn').onclick=()=>{
    let csv='å•†å“,ä¾›åº”å•†,æŠ¥ä»·,äº¤æœŸ\\n';
    document.querySelectorAll('#quoteTable tbody tr').forEach(tr=>{
      if(tr.style.display==='none') return;
      const cells=[...tr.children].slice(0,4).map(td=>td.textContent.trim());
      csv += cells.join(',') + '\\n';
    });
    const blob=new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='quotes.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  /* 5. èŠå¤© & é€šçŸ¥æŒ‰é’®é€»è¾‘ï¼ˆå¯æåˆ° common.jsï¼‰ */
  document.addEventListener('click',e=>{
    if(e.target.classList.contains('btn-chat')){
      const sup=e.target.dataset.sup;
      document.getElementById('chatTitle').textContent=`ä¸ ${sup} æ²Ÿé€š`;
      document.getElementById('chatBody').innerHTML='';
      document.getElementById('chatPopup').style.display='flex';
    }
    if(e.target.classList.contains('btn-inform')){
      alert(`å·²å‘ ${e.target.dataset.sup} å‘é€æŠ¥ä»·éœ€æ±‚ï¼ï¼ˆç¤ºä¾‹ï¼‰`);
    }
  });
  function chatClose(){document.getElementById('chatPopup').style.display='none';}
  function sendMsg(){
    const ta=document.getElementById('chatInput');
    const msg=ta.value.trim();
    if(!msg)return;
    const body=document.getElementById('chatBody');
    body.innerHTML += `<div style="text-align:right;color:#2c7be5;">${msg}</div>`;
    body.scrollTop=body.scrollHeight;
    ta.value='';
  }
  </script>
</body>
</html>